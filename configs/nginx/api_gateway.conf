# VVTV Public API Gateway Configuration
# NGINX configuration for secure multi-tenant LLM Pool API

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=perip:10m rate=30r/m;
limit_req_zone $http_x_api_key zone=pertenant:10m rate=120r/m;

# Upstream to LLM Pool API
upstream llm_pool_api {
    server 127.0.0.1:7070;
    keepalive 32;
}

# Main API server
server {
    listen 7071;
    server_name api.vvtv.local;
    
    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    
    # Request size limits
    client_max_body_size 1m;
    client_body_timeout 10s;
    client_header_timeout 10s;
    
    # Logging
    access_log /vvtv/logs/api_access.log combined;
    error_log /vvtv/logs/api_error.log warn;
    
    # Health endpoint (no auth required)
    location = /v1/health/ready {
        proxy_pass http://llm_pool_api/health/ready;
        proxy_connect_timeout 2s;
        proxy_read_timeout 5s;
        
        # Add request ID
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Main inference endpoint (authenticated)
    location = /v1/infer {
        # Rate limiting (per IP and per tenant)
        limit_req zone=perip burst=10 nodelay;
        limit_req zone=pertenant burst=30 nodelay;
        
        # Proxy to LLM Pool
        proxy_pass http://llm_pool_api/infer;
        proxy_connect_timeout 2s;
        proxy_read_timeout 120s;  # Allow for longer inference times
        proxy_send_timeout 10s;
        
        # Pass authentication headers
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Api-Key $http_x_api_key;
        proxy_set_header X-Timestamp $http_x_timestamp;
        proxy_set_header X-Nonce $http_x_nonce;
        proxy_set_header X-Signature $http_x_signature;
        proxy_set_header Authorization $http_authorization;
        
        # Handle CORS if needed
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin '*';
            add_header Access-Control-Allow-Methods 'POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'X-Api-Key, X-Timestamp, X-Nonce, X-Signature, Authorization, Content-Type';
            add_header Access-Control-Max-Age 86400;
            return 204;
        }
    }
    
    # Usage endpoint (authenticated, read-only)
    location = /v1/usage {
        limit_req zone=pertenant burst=10 nodelay;
        
        proxy_pass http://llm_pool_api/usage;
        proxy_connect_timeout 2s;
        proxy_read_timeout 10s;
        
        # Pass authentication headers
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Api-Key $http_x_api_key;
        proxy_set_header X-Timestamp $http_x_timestamp;
        proxy_set_header X-Nonce $http_x_nonce;
        proxy_set_header X-Signature $http_x_signature;
        proxy_set_header Authorization $http_authorization;
    }
    
    # Key rotation endpoint (authenticated, limited)
    location = /v1/keys/rotate {
        limit_req zone=pertenant burst=1 nodelay;
        
        proxy_pass http://llm_pool_api/keys/rotate;
        proxy_connect_timeout 2s;
        proxy_read_timeout 30s;
        
        # Pass authentication headers
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Api-Key $http_x_api_key;
        proxy_set_header X-Timestamp $http_x_timestamp;
        proxy_set_header X-Nonce $http_x_nonce;
        proxy_set_header X-Signature $http_x_signature;
    }
    
    # Block all other requests
    location / {
        return 404 '{"error":"endpoint_not_found","message":"Valid endpoints: /v1/health/ready, /v1/infer, /v1/usage"}';
        add_header Content-Type application/json;
    }
}

# Optional: HTTPS redirect server
server {
    listen 80;
    server_name api.vvtv.local;
    return 301 https://$server_name$request_uri;
}