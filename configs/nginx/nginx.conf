worker_processes auto;
error_log /vvtv/system/logs/nginx_error.log warn;
pid /vvtv/system/logs/nginx.pid;

events {
    worker_connections 1024;
    multi_accept on;
}

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        ping 5s;
        notify_method get;

        application live {
            live on;
            record off;
            allow publish 100.64.0.0/10;
            deny publish all;
            allow play 0.0.0.0/0;
            idle_streams off;

            hls on;
            hls_path /vvtv/broadcast/hls;
            hls_fragment 4s;
            hls_playlist_length 2880s; # 48 minutos
            hls_cleanup on;
            hls_continuous on;
            hls_nested on;
            hls_variant _720p BANDWIDTH=4000000 RESOLUTION=1280x720;

            exec_publish /vvtv/system/bin/check_stream_health.sh --quiet;
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    tcp_nopush      on;
    keepalive_timeout  65;
    server_tokens off;

    access_log /vvtv/system/logs/nginx_access.log combined;

    server {
        listen 8080;
        server_name _;

        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        location /hls/ {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /vvtv/broadcast;
            add_header Cache-Control "no-cache";
        }

        location /status {
            rtmp_stat all;
            rtmp_stat_stylesheet /stat.xsl;
            satisfy any;
            allow 100.64.0.0/10;
            allow 127.0.0.1;
            deny all;
            auth_basic "Restricted";
            auth_basic_user_file /vvtv/system/nginx.htpasswd;
        }

        location /stat.xsl {
            root /usr/share/nginx/html;
        }
    }
}
